<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Test Case Generator</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      padding: 2rem;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    input, select {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      background: #0070f3;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover {
      background: #0059c1;
    }
    #output {
      margin-top: 1.5rem;
      max-height: 500px;
      overflow-y: auto;
      border: 1px solid #eee;
      padding: 1rem;
      border-radius: 4px;
    }
    pre {
      white-space: pre-wrap;
      word-break: break-all;
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Test Case Generator</h1>
    <form id="url-form">
      <input type="text" id="url-input" placeholder="Enter website URL" required />
      <select id="format-select">
        <option value="plain">Plain Text</option>
        <option value="katalon">Katalon Format</option>
        <option value="maestro">Maestro Format</option>
      </select>
      <button type="submit">Generate Test Cases</button>
    </form>
    <div id="output"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
    // Get elements
    const urlForm = document.getElementById('url-form');
    const urlInput = document.getElementById('url-input');
    const formatSelect = document.getElementById('format-select');
    const output = document.getElementById('output');
    
    // Add container for "Generate Next Test" button
    const nextTestContainer = document.createElement('div');
    nextTestContainer.className = 'next-test-container';
    nextTestContainer.style.display = 'none';
    nextTestContainer.innerHTML = `
      <button id="generate-next-test" class="button-secondary">Generate Next Test</button>
      <span id="element-info"></span>
    `;
    document.querySelector('.container').insertBefore(nextTestContainer, output);
    
    // Current session state
    const sessionState = {
      sessionId: null,
      nextElementType: null,
      nextElementIndex: 0,
      hasMoreElements: false,
      testCases: []
    };
    
    // Handle form submission - generate first test
    urlForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Reset session state
      sessionState.sessionId = null;
      sessionState.testCases = [];
      nextTestContainer.style.display = 'none';
      
      // Show loading state
      output.innerHTML = '<div class="spinner"></div><p>Analyzing website...</p>';
      
      try {
        // Add a client-side timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 25000); // 25 second timeout
        
        const response = await fetch('/api/generate-incremental', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url: urlInput.value,
            mode: 'first',
            format: formatSelect.value
          }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          // Store session info
          sessionState.sessionId = data.sessionId;
          sessionState.nextElementType = data.nextElementType;
          sessionState.nextElementIndex = data.nextElementIndex;
          sessionState.hasMoreElements = data.hasMoreElements;
          sessionState.testCases = sessionState.testCases.concat(data.testCases);
          
          // Render test cases
          renderTestCases(data.testCases);
          
          // Show "Generate Next Test" button if more elements are available
          if (data.hasMoreElements) {
            nextTestContainer.style.display = 'block';
            updateElementInfo();
          }
        } else {
          output.innerHTML = `<p>‚ùå Error: ${data.error}</p>`;
        }
      } catch (error) {
        if (error.name === 'AbortError') {
          output.innerHTML = `<p>‚ùå Error: Request timed out. Please try a simpler website.</p>`;
        } else {
          output.innerHTML = `<p>‚ùå Error: ${error.message}</p>`;
        }
      }
    });
    
    // Handle "Generate Next Test" button click
    document.getElementById('generate-next-test').addEventListener('click', async () => {
      if (!sessionState.sessionId || !sessionState.hasMoreElements) return;
      
      // Show loading state for next test
      const currentContent = output.innerHTML;
      output.innerHTML += '<div class="spinner"></div><p>Generating next test...</p>';
      
      try {
        const response = await fetch('/api/generate-incremental', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            mode: 'next',
            sessionId: sessionState.sessionId,
            elementType: sessionState.nextElementType,
            elementIndex: sessionState.nextElementIndex,
            format: formatSelect.value
          })
        });
        
        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
          // Update session info
          sessionState.nextElementType = data.nextElementType;
          sessionState.nextElementIndex = data.nextElementIndex;
          sessionState.hasMoreElements = data.hasMoreElements;
          sessionState.testCases = sessionState.testCases.concat(data.testCases);
          
          // Render the new test case
          output.innerHTML = currentContent;
          renderTestCases(data.testCases);
          
          // Update "Generate Next Test" button visibility
          if (data.hasMoreElements) {
            nextTestContainer.style.display = 'block';
            updateElementInfo();
          } else {
            nextTestContainer.style.display = 'none';
          }
        } else {
          output.innerHTML = currentContent + `<p>‚ùå Error: ${data.error}</p>`;
          if (!data.hasMoreElements) {
            nextTestContainer.style.display = 'none';
          }
        }
      } catch (error) {
        output.innerHTML = currentContent + `<p>‚ùå Error: ${error.message}</p>`;
      }
    });
    
    // Function to render test cases
    function renderTestCases(testCases) {
      if (!testCases || testCases.length === 0) return;
      
      testCases.forEach(testCase => {
        const testCaseHtml = `
          <div class="test-case">
            <h3>${testCase.id}: ${testCase.title}
              <span class="test-case-priority priority-${testCase.priority.toLowerCase()}">${testCase.priority}</span>
            </h3>
            <div class="test-case-description">${testCase.description}</div>
            <div class="test-steps">
              <div class="test-step">
                <div class="step-number">#</div>
                <div class="step-action"><strong>Action</strong></div>
                <div class="step-expected"><strong>Expected Result</strong></div>
              </div>
              ${testCase.steps.map(step => `
                <div class="test-step">
                  <div class="step-number">${step.step}</div>
                  <div class="step-action">${step.action}</div>
                  <div class="step-expected">${step.expected}</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
        
        output.innerHTML += testCaseHtml;
      });
    }
    
    // Update element info text
    function updateElementInfo() {
      const elementInfo = document.getElementById('element-info');
      if (sessionState.nextElementType) {
        elementInfo.textContent = `Next: ${sessionState.nextElementType} #${sessionState.nextElementIndex + 1}`;
      } else {
        elementInfo.textContent = '';
      }
    }
  });
  </script>
</body>
</html>
