<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Test Case Generator</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      padding: 2rem;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    input, select {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    button {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      background: #0070f3;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover {
      background: #0059c1;
    }
    .button-secondary {
      background: #6c757d;
    }
    .button-secondary:hover {
      background: #5a6268;
    }
    .button-group {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    .hidden {
      display: none;
    }
    #output {
      margin-top: 1.5rem;
      max-height: 600px;
      overflow-y: auto;
      border: 1px solid #eee;
      padding: 1rem;
      border-radius: 4px;
    }
    pre {
      white-space: pre-wrap;
      word-break: break-all;
      background: #f5f5f5;
      padding: 1rem;
      border-radius: 4px;
      overflow-x: auto;
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    h2 {
      font-size: 1.2rem;
      margin-top: 1.5rem;
      color: #444;
    }
    .test-case {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .test-case h3 {
      margin-top: 0;
      color: #212529;
    }
    .test-case-description {
      color: #6c757d;
      font-style: italic;
      margin-bottom: 1rem;
    }
    .test-case-priority {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      font-size: 0.8rem;
      border-radius: 4px;
      margin-left: 0.5rem;
    }
    .priority-high {
      background: #f8d7da;
      color: #721c24;
    }
    .priority-medium {
      background: #fff3cd;
      color: #856404;
    }
    .priority-low {
      background: #d1e7dd;
      color: #0f5132;
    }
    .test-steps {
      margin-top: 1rem;
    }
    .test-step {
      display: flex;
      margin-bottom: 0.5rem;
    }
    .step-number {
      flex: 0 0 40px;
      font-weight: bold;
    }
    .step-action {
      flex: 1;
    }
    .step-expected {
      flex: 1;
      color: #0d6efd;
    }
    .download-options {
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 6px;
    }
    .format-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      font-weight: bold;
      border-radius: 4px;
      margin-left: 0.5rem;
      background: #e9ecef;
      color: #495057;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ Test Case Generator</h1>
    <form id="url-form">
      <input type="text" id="url-input" placeholder="Enter website URL (include http:// or https://)" required />
      <select id="format-select">
        <option value="plain">Plain Text</option>
        <option value="katalon">Katalon Format</option>
        <option value="maestro">Maestro Format</option>
      </select>
      <button type="submit">Generate Test Cases</button>
    </form>
    
    <div id="download-container" class="hidden">
      <div class="download-options">
        <h3>Download Options</h3>
        <div class="button-group">
          <button id="download-txt" class="button-secondary">Download as TXT</button>
          <button id="download-json" class="button-secondary">Download as JSON</button>
          <button id="download-csv" class="button-secondary">Download as CSV</button>
          <button id="download-html" class="button-secondary">Download as HTML</button>
        </div>
      </div>
    </div>
    
    <div id="output"></div>
  </div>

  <script>
    // Debug logger that styles console output for better readability
    const logger = {
      info: (label, data) => {
        console.log(`%cüìù ${label}:`, 'color: #0070f3; font-weight: bold;', data);
      },
      warn: (label, data) => {
        console.warn(`%c‚ö†Ô∏è ${label}:`, 'color: #ff9800; font-weight: bold;', data);
      },
      error: (label, data) => {
        console.error(`%cüõë ${label}:`, 'color: #f44336; font-weight: bold;', data);
      },
      success: (label, data) => {
        console.log(`%c‚úÖ ${label}:`, 'color: #4caf50; font-weight: bold;', data);
      },
      group: (label) => {
        console.group(`%cüìä ${label}`, 'color: #9c27b0; font-weight: bold;');
      },
      groupEnd: () => {
        console.groupEnd();
      }
    };

    // Store the test data globally for download buttons to use
    let testData = null;
    
    document.getElementById('url-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const url = document.getElementById('url-input').value;
      const format = document.getElementById('format-select').value;
      const output = document.getElementById('output');
      const downloadContainer = document.getElementById('download-container');
      
      // Clear previous test data
      testData = null;
      downloadContainer.classList.add('hidden');
      
      output.innerHTML = '‚è≥ Generating test cases...';

      logger.group('Test Case Generation Request');
      logger.info('Request Parameters', { url, format });
      
      // Validate URL format on client side first
      let isValidUrl = false;
      try {
        new URL(url);
        isValidUrl = true;
        logger.success('URL Validation', 'Valid URL format');
      } catch (error) {
        logger.error('URL Validation', `Invalid URL format: ${error.message}`);
        output.innerHTML = `<p>‚ùå Error: Invalid URL format. Make sure to include http:// or https://</p>`;
        logger.groupEnd();
        return;
      }

      try {
        logger.info('Sending Request', 'Starting fetch operation');
        const startTime = performance.now();
        
        // Add a client-side timeout as well
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          logger.warn('Request Timeout', 'Client-side timeout triggered after 30 seconds');
          controller.abort();
        }, 30000);
        
        logger.info('Request Details', {
          endpoint: '/api/generate-tests',
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, format })
        });
        
        // Make the actual request
        const response = await fetch('/api/generate-tests', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ url, format }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        const endTime = performance.now();
        logger.info('Response Time', `${Math.round(endTime - startTime)}ms`);
        
        logger.group('Response Details');
        logger.info('Status', response.status);
        logger.info('Status Text', response.statusText);
        logger.info('OK', response.ok);
        
        // Log headers
        const headers = {};
        response.headers.forEach((value, key) => {
          headers[key] = value;
        });
        logger.info('Headers', headers);
        logger.groupEnd();
        
        if (!response.ok) {
          logger.error('Response Error', `Server responded with status: ${response.status}`);
          output.innerHTML = `<p>‚ùå Error: Server responded with status: ${response.status}</p>`;
          
          // Try to get error details if possible
          try {
            const errorText = await response.text();
            logger.error('Error Details', errorText);
            try {
              const errorJson = JSON.parse(errorText);
              logger.error('Error JSON', errorJson);
              if (errorJson.error) {
                output.innerHTML = `<p>‚ùå Error: ${errorJson.error}</p>`;
              }
            } catch (e) {
              // Not JSON, use text
              if (errorText) {
                output.innerHTML += `<pre>${errorText}</pre>`;
              }
            }
          } catch (e) {
            logger.error('Error Reading Response', e);
          }
        } else {
          try {
            const data = await response.json();
            logger.success('Response Data', data);
            testData = data; // Store for download buttons
            
            if (data.success) {
              let outputHtml = '';
              
              if (data.note) {
                logger.warn('Processing Note', data.note);
                outputHtml += `<p>‚ö†Ô∏è Note: ${data.note}</p>`;
              }
              
              // Check which format the test cases are in
              if (typeof data.testCases === 'string') {
                // For Katalon or Maestro format (text-based)
                outputHtml += `<pre>${data.testCases}</pre>`;
              } else if (Array.isArray(data.testCases) && typeof data.testCases[0] === 'string') {
                // Old format - simple array of strings
                outputHtml += data.testCases.map(tc => `<p>‚úÖ ${tc}</p>`).join('');
              } else if (Array.isArray(data.testCases) && typeof data.testCases[0] === 'object') {
                // New detailed format - render nicely
                outputHtml += `<h2>Generated Test Cases for ${url}</h2>`;
                
                data.testCases.forEach(testCase => {
                  outputHtml += `
                    <div class="test-case">
                      <h3>${testCase.id}: ${testCase.title}
                        <span class="test-case-priority priority-${testCase.priority.toLowerCase()}">${testCase.priority}</span>
                      </h3>
                      <div class="test-case-description">${testCase.description}</div>
                      <div class="test-steps">
                        <div class="test-step">
                          <div class="step-number">#</div>
                          <div class="step-action"><strong>Action</strong></div>
                          <div class="step-expected"><strong>Expected Result</strong></div>
                        </div>
                        ${testCase.steps.map(step => `
                          <div class="test-step">
                            <div class="step-number">${step.step}</div>
                            <div class="step-action">${step.action}</div>
                            <div class="step-expected">${step.expected}</div>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  `;
                });
                
                // Show download options
                downloadContainer.classList.remove('hidden');
              } else {
                // Unknown format, display JSON
                outputHtml += `<pre>${JSON.stringify(data.testCases, null, 2)}</pre>`;
              }
              
              output.innerHTML = outputHtml;
            } else {
              logger.error('Processing Error', data.error);
              output.innerHTML = `<p>‚ùå Error: ${data.error}</p>`;
              
              // Still show test cases if they exist
              if (data.testCases) {
                if (Array.isArray(data.testCases)) {
                  if (typeof data.testCases[0] === 'string') {
                    output.innerHTML += data.testCases.map(tc => `<p>‚úÖ ${tc}</p>`).join('');
                  } else {
                    // Detailed test case format
                    output.innerHTML += renderDetailedTestCases(data.testCases, url);
                    // Show download options
                    downloadContainer.classList.remove('hidden');
                  }
                } else {
                  output.innerHTML += `<pre>${data.testCases}</pre>`;
                }
              }
            }
          } catch (error) {
            logger.error('JSON Parsing Error', error);
            output.innerHTML = `<p>‚ùå Error: Could not parse response: ${error.message}</p>`;
            
            try {
              const text = await response.text();
              logger.error('Raw Response', text);
              output.innerHTML += `<pre>${text}</pre>`;
            } catch (e) {
              logger.error('Error Reading Raw Response', e);
            }
          }
        }
      } catch (error) {
        logger.error('Request Error', error);
        
        if (error.name === 'AbortError') {
          output.innerHTML = `<p>‚ùå Error: Request timed out after 30 seconds</p>`;
        } else {
          output.innerHTML = `<p>‚ùå Error: ${error.message}</p>`;
        }
      }
      
      logger.groupEnd();
    });
    
    // Helper function to render detailed test cases
    function renderDetailedTestCases(testCases, url) {
      let html = `<h2>Generated Test Cases for ${url}</h2>`;
      
      testCases.forEach(testCase => {
        html += `
          <div class="test-case">
            <h3>${testCase.id}: ${testCase.title}
              <span class="test-case-priority priority-${testCase.priority.toLowerCase()}">${testCase.priority}</span>
            </h3>
            <div class="test-case-description">${testCase.description}</div>
            <div class="test-steps">
              <div class="test-step">
                <div class="step-number">#</div>
                <div class="step-action"><strong>Action</strong></div>
                <div class="step-expected"><strong>Expected Result</strong></div>
              </div>
              ${testCase.steps.map(step => `
                <div class="test-step">
                  <div class="step-number">${step.step}</div>
                  <div class="step-action">${step.action}</div>
                  <div class="step-expected">${step.expected}</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      });
      
      return html;
    }
    
    // Download as TXT
    document.getElementById('download-txt').addEventListener('click', () => {
      if (!testData) return;
      
      let content = `TEST CASES FOR ${testData.pageData.url}\n`;
      content += `Generated: ${new Date().toLocaleString()}\n\n`;
      
      testData.testCases.forEach(testCase => {
        content += `${testCase.id}: ${testCase.title} (${testCase.priority})\n`;
        content += `${testCase.description}\n\n`;
        content += `Steps:\n`;
        
        testCase.steps.forEach(step => {
          content += `${step.step}. ${step.action} => ${step.expected}\n`;
        });
        
        content += `\n\n`;
      });
      
      downloadFile(content, 'test-cases.txt', 'text/plain');
    });
    
    // Download as JSON
    document.getElementById('download-json').addEventListener('click', () => {
      if (!testData) return;
      
      const content = JSON.stringify({
        url: testData.pageData.url,
        generated: new Date().toISOString(),
        testCases: testData.testCases
      }, null, 2);
      
      downloadFile(content, 'test-cases.json', 'application/json');
    });
    
    // Download as CSV
    document.getElementById('download-csv').addEventListener('click', () => {
      if (!testData) return;
      
      let content = 'ID,Title,Priority,Description,Step Number,Action,Expected\n';
      
      testData.testCases.forEach(testCase => {
        testCase.steps.forEach(step => {
          // Escape any commas in the fields
          const escapedTitle = `"${testCase.title.replace(/"/g, '""')}"`;
          const escapedDescription = `"${testCase.description.replace(/"/g, '""')}"`;
          const escapedAction = `"${step.action.replace(/"/g, '""')}"`;
          const escapedExpected = `"${step.expected.replace(/"/g, '""')}"`;
          
          content += `${testCase.id},${escapedTitle},${testCase.priority},${escapedDescription},${step.step},${escapedAction},${escapedExpected}\n`;
        });
      });
      
      downloadFile(content, 'test-cases.csv', 'text/csv');
    });
    
    // Download as HTML
    document.getElementById('download-html').addEventListener('click', () => {
      if (!testData) return;
      
      let content = `
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Test Cases for ${testData.pageData.url}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            h1 { color: #333; }
            .test-case { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
            .test-case h2 { margin-top: 0; color: #0070f3; }
            .priority { display: inline-block; padding: 3px 8px; border-radius: 3px; font-size: 12px; margin-left: 10px; }
            .priority-high { background: #ffebee; color: #c62828; }
            .priority-medium { background: #fff8e1; color: #ff8f00; }
            .priority-low { background: #e8f5e9; color: #2e7d32; }
            .description { color: #666; font-style: italic; margin-bottom: 15px; }
            table { width: 100%; border-collapse: collapse; }
            th, td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
            th { background-color: #f5f5f5; }
          </style>
        </head>
        <body>
          <h1>Test Cases for ${testData.pageData.url}</h1>
          <p>Generated: ${new Date().toLocaleString()}</p>
      `;
      
      testData.testCases.forEach(testCase => {
        content += `
          <div class="test-case">
            <h2>${testCase.id}: ${testCase.title} <span class="priority priority-${testCase.priority.toLowerCase()}">${testCase.priority}</span></h2>
            <div class="description">${testCase.description}</div>
            <table>
              <tr>
                <th>#</th>
                <th>Action</th>
                <th>Expected Result</th>
              </tr>
        `;
        
        testCase.steps.forEach(step => {
          content += `
            <tr>
              <td>${step.step}</td>
              <td>${step.action}</td>
              <td>${step.expected}</td>
            </tr>
          `;
        });
        
        content += `
            </table>
          </div>
        `;
      });
      
      content += `
        </body>
        </html>
      `;
      
      downloadFile(content, 'test-cases.html', 'text/html');
    });
    
    // Helper function to download a file
    function downloadFile(content, fileName, contentType) {
      const blob = new Blob([content], { type: contentType });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    }
  </script>
</body>
</html>
